---
Title: 部署策略
Tags: [类型/笔记, 运维/部署]
---

# 部署策略

---

## 重建部署

传统的冗余方式。要求先下线版本 A，再部署上线版本 B。

服务的宕机时间依赖于应用下线和启动耗时。

优点：
- 便于设置
- 系统状态完整
- 不需要额外的生产服务器

缺点：
- 对用户影响大

## 蓝绿部署

同时使用两套生产环境，但是流量在某一时刻是唯一的。

> 蓝指的是旧版本 A 的生产环境，拥有实际流量；绿指的是新版本 B 的生产环境。

上线发布时，通过负载均衡层，将用户的流量从蓝色环境转发到绿色环境，完成上线。上线结束后，蓝色环境可以脱机，作为发生问题时的回滚版本；或者留作为下一次更新准备。

优点：
- 实时发布、回滚
- 避免版本冲突
- 系统状态统一

缺点：
* 资源要求倍增

## 滚动部署

增量部署。逐个替换应用的实例，缓慢发布一个版本。

新版本 B 的实例部署成功后，旧版本实例 A 下线；然后准备部署 B 的下一个实例，直到所有的实例替换完成。

通常配置参数：
- 并行数。最大批量执行数。同时发布的实例个数。
- 最大峰值。当前，实例可以加入的最大数目。
- 最大不可用数。滚动更新中，最多可以同时存在的下线不可用实例。

优点：
- 实时发布、回滚
- 额外资源负担较小

缺点：
- 发布、回滚较耗时
- 无法控制流量
- 滚动时，新老系统并存，可能导致状态不稳定

## 金丝雀部署

### 灰度发布

金丝雀部署是带有流量控制的蓝绿部署。流量按比例逐步从旧版本 A 转发到新版本 B。

> 灰度指的是新版本 B 的流量。

优点：
- 快速回滚
- 方便错误评估和性能监控
- 版本可以面向部分用户

缺点：
- 发布缓慢

### A/B 测试

A/B 测试通常不是指部署策略，而是商业决策。可以通过在金丝雀部署上添加额外功能实现。

由于 A 版本和 B 版本同时运行，因此可以监控两个版本中不同流量带来的各项数据指标。

A/B 测试主要可以将不同运行环境、特定参数分开，如：
- 地理位置
- 语言
- 硬件支持（浏览器版本、屏幕尺寸、操作系统等）

优点：
- 多个版本并行运行
- 完全控制流量分布

缺点：
- 较难定位问题
- 需要足够强大的负载均衡

## 影子部署

在旧版本 A 的一旁同时发布新版本 B，将进入 A 的流量，同步转发到 B。当 B 满足了各项指标后，则正式发布，同时下线 A。

这个技术需要仿真服务器来响应客户的操作，这即影子的含义。例如购物平台，用户为他们的订单在 A 和 B 中分别支付了一次，我们需要避免影子服务器影响到真实中的支付服务造成损失。

优点：
- 可以使用真实的生产环境流量进行测试
- 对用户无影响
- 确保上线时满足了需求

缺点：
- 资源要求倍增
- 配置复杂
- 需要仿真服务

## 总结

1. 实际采用哪种方式主要取决于需求和预算。
2. 当发布到开发或沙盒环境时，重建或是滚动是个好选择；当发布到生产环境时，滚动、蓝绿或者金丝雀则更胜一筹。
3. 从预算角度来说，蓝绿和影子都需要双倍的资源，滚动和金丝雀则相对消耗更小。
4. 如果涉及到了使用地理、语言等特定参数的业务，应当考虑使用 A/B 测试。